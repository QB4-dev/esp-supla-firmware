<!DOCTYPE html>
<html lang="en">
<head>
	<title>SUPLA web config</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="supla.css">
</head>
<body>
<div id="navbar" class="navbar"></div>
	<div id="SUPLA" class="tab">
		<div id="device">Loading ...</div><br>
		<div id="supla">Loading ...</div>
	</div>

	<div id="WiFi" class="tab">
		<div id="net">Loading ...</div><br>
		<div id="wifi">Loading ...</div>
	</div>

	<div id="Conf" class="tab">
			<div id="brd">Loading ...</div>
	</div>

	<div id="Fw" class="tab">
		<div id="app">Loading ...</div><br>
		<div class="row">
			<form id="fotaForm" class="file-form" method="post" action="/update" enctype="multipart/form-data">
					<input type="file" name="firmware" accept=".bin">
					<input type="submit" value="UPGRADE" name="submit"></input>
			</form>
		</div>
	</div>
</div>

<script>
//const esp_url="http://192.168.100.18";
//const esp_url="http://192.168.4.1";
const esp_url="";

function tab(e, id) {
  var i, content;

  content = document.getElementsByClassName("tab");
  for (i = 0; i < content.length; i++) {
    content[i].style.display = "none";
  }

  document.getElementById(id).style.display = "block";
  e.currentTarget.className += " active";
}

function getNavbar(div){
		let navbar = `
		<input class="menu-btn" type="checkbox" id="menu-btn" />
		<label class="menu-icon" for="menu-btn"><span class="navicon"></span></label>
		<ul class="menu">
			<li><a onclick="tab(event,'WiFi')">WiFi</a></li>
			<li><a onclick="tab(event,'SUPLA')" id="default">SUPLA</a></li>
			<li><a onclick="tab(event,'Conf')">Config</a></li>
			<li><a onclick="tab(event,'Fw')">Firmware</a></li>
		</ul>`;
		div.innerHTML = navbar;
}

function suplaStats(){
	fetch(esp_url+"/supla")
	.then(r => r.json())
	.then(js => {
		const div = document.getElementById('device');

		function secToTime(e){
			const h = Math.floor(e / 3600).toString().padStart(2,'0'),
			m = Math.floor(e % 3600 / 60).toString().padStart(2,'0'),
			s = Math.floor(e % 60).toString().padStart(2,'0');
			return h + ':' + m + ':' + s;
		}

		let stats = `<small>
		Device: ${js.data.name}<br>
		software: ${js.data.software_ver}<br>
		state: ${js.data.state}<br>
		GUID: ${js.data.guid}<br>
		uptime: ${secToTime(js.data.uptime)}<br>
		connection uptime: ${secToTime(js.data.connection_uptime)}
		</small>`;

		div.innerHTML = stats;
		return setTimeout(suplaStats, 2000);
	});
}

function netStats(){
	fetch(esp_url+"/wifi")
	.then(r => r.json())
	.then(js => {
		const div = document.getElementById('net');
		let sta = js.data.sta;

		let stats = `
			<small>
				Status: ${sta.status}<br>`;
		if(sta.connection)
			stats += `
				Network: ${sta.connection.ssid}<br>
				authmode: ${sta.connection.authmode}<br>
				RSSI: ${sta.connection.rssi} dB<br>`;

		stats +=`
			IP addr: ${sta.ip_info.ip}<br>
			netmask: ${sta.ip_info.netmask}<br>
			gateway: ${sta.ip_info.gw}
		</small>`;

		div.innerHTML = stats;
		return setTimeout(netStats, 2000);
	});
}

function getWiFiConfigForm(){
	fetch(esp_url+"/wifi?action=get_config")
	.then(r => r.json())
	.then(js => {
		const div = document.getElementById('wifi');

		let html = `
		<form id="wifi-form" method="post">
			<strong>WiFi config:</strong><br>
			SSID<br>
			<input type="text" name="ssid" value="${js.data.sta.ssid}" style="max-width:300px"><br>
			Password<br>
			<input type="password" name="passwd" style="max-width:300px"><br>
			<input type="submit" value="submit">
		</form>`;

		div.innerHTML = html;
		const form = document.getElementById('wifi-form');
		form.onsubmit = function(e){
			e.preventDefault();
			let data = decodeURIComponent(new URLSearchParams(new FormData(this)));

			fetch(esp_url+"/wifi?action=connect",
			{
				method: "POST",
				body: data
			})
			.then(r => r.json())
			.then(js => { alert("WiFi config changed"); });
		};
	})
}

function getSuplaConfigForm(){
	fetch(esp_url+"/supla?action=get_config")
	.then(r => r.json())
	.then(js => {
		const div = document.getElementById('supla');

		let html = `
		<form id="supla-form" method="post">
			<strong>SUPLA config:</strong><br>
			Email<br>
			<input type="text" name="email" value=${js.data.email} style="max-width:300px"><br>
			Server<br>
			<input type="text" name="server" value=${js.data.server} style="max-width:300px"><br>
			<input type="submit" value="submit">
		</form>`;

		div.innerHTML = html;
		const form = document.getElementById('supla-form');
		form.onsubmit = function(e){
			e.preventDefault();
			let data = decodeURIComponent(new URLSearchParams(new FormData(this)));

			fetch(esp_url+"/supla?action=set_config",
			{
				method: "POST",
				body: data
			})
			.then(r => r.json())
			.then(js => { alert("SUPLA config changed"); });
		};

	})
}

function getSettingsForm(){
	fetch(esp_url+"/settings")
	.then(r => r.json())
	.then(js => {
		const div = document.getElementById('brd');

		let html = `<form id="brd-form" method="post">`;
		js.data.groups.forEach((gr, i) => {
			html+=`${gr.label}:<br>`;
			html+='<small>';
			gr.settings.forEach((item, i) => {
				switch (item.type) {
					case "BOOL":
						html+=`<input type="checkbox" name="${gr.label}:${item.label}" ${item.val?"checked":''}>${item.label}<br>`;
						break;
					case "NUM":
						html+=`${item.label}<br><input type="number" name="${gr.label}:${item.label}" min=${item.min} max=${item.max} value=${item.val} style="width:150px"><br>`;
						break;
					case "ONEOF":
						html+=`${item.label}<br><select name="${gr.label}:${item.label}" style="width:160px">`;
						item.labels.forEach((label, i) => { html+=` <option value=${i} ${item.val==i?"selected":''}>${label}</option>`;});
						html+=`</select><br>`;
						break;
					default:
						break;
				}
			});
			html+=`</small>`;
		});
		html+=`<input type="submit" value="submit"></form>`;

		div.innerHTML = html;
		const form = document.getElementById('brd-form');
		form.onsubmit = function(e){
			e.preventDefault();
			let data = decodeURIComponent(new URLSearchParams(new FormData(this)));
			fetch(esp_url+"/settings?action=set",
			{
				method: "POST",
				body: data
			})
			.then(r => r.json())
			.then(js => { alert("board config changed"); });
		};
	})
}

function appInfo(){
	fetch(esp_url+"/info")
	.then(r => r.json())
	.then(js => {
		const div = document.getElementById('app');

		let info = `
			<h6>Firmware:</h6>
			<small>project: ${js.project_name}</small><br>
			<small>version: ${js.version}</small><br>
			<small>idf_ver: ${js.idf_ver}</small><br>
			<small>bulid date: ${js.date}</small><br>
			<small>bulid time: ${js.time}</small><br>`;

		div.innerHTML = info;
	});
}

function uploadFile(event){
	event.preventDefault();
	var xhttp = new XMLHttpRequest();
	var data = new FormData(event.target);

	xhttp.onload = function() {
		if(this.status == 200){
			var js = JSON.parse(this.responseText);
			alert((js.result==='ESP_OK')?('Update success:\n\n'+js.bytes_uploaded +'b uploaded'):('Update error'));
		} else {
			alert('Request Error');
		}
		event.target.style.display = 'block';
	};

	xhttp.ontimeout = function(e) {
		info.innerHTML='Error: request timed out';
		event.target.style.display = 'block';
	};

	xhttp.timeout = 120000;
	xhttp.open("POST",event.target.action, true);
	event.target.style.display = 'none';
	xhttp.send(data);
}

getNavbar(document.getElementById('navbar'));

suplaStats();
netStats();
getWiFiConfigForm();
getSuplaConfigForm();
getSettingsForm();
appInfo();
document.getElementById("fotaForm").addEventListener("submit", uploadFile);
document.getElementById("default").click();
</script>

</body>
</html>
